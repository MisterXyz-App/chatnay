{% extends "base.html" %}

{% block title %}Dashboard - Chat App{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Welcome Header -->
    <div class="bg-gradient-to-r from-blue-700 to-indigo-800 rounded-2xl shadow-xl overflow-hidden">
        <div class="px-8 py-8 text-white">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-6 mb-4 md:mb-0">
                    <div class="relative">
                        <img src="{{ current_user.profile_picture }}" alt="{{ current_user.username }}" 
                             class="w-20 h-20 rounded-full border-4 border-white/30 shadow-2xl object-cover">
                        {% if current_user.is_admin %}
                        <div class="absolute -bottom-2 -right-2 bg-gradient-to-r from-yellow-400 to-yellow-500 text-yellow-900 rounded-full p-2 shadow-lg">
                            <i class="fas fa-crown text-xs"></i>
                        </div>
                        {% endif %}
                        <div class="absolute -bottom-2 -left-2 bg-gradient-to-r from-green-400 to-green-500 text-white rounded-full p-1.5 shadow-lg">
                            <i class="fas fa-circle text-xs"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">Selamat Datang, {{ current_user.username }}!</h1>
                        <p class="text-blue-100 text-lg mt-2 font-medium">
                            {% if current_user.is_admin %}
                            Anda login sebagai <strong class="bg-white/20 px-2 py-1 rounded-lg">Administrator</strong>
                            {% else %}
                            Siap untuk memulai percakapan?
                            {% endif %}
                        </p>
                        <div class="flex items-center space-x-3 mt-3">
                            <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium border border-white/30">
                                <i class="fas fa-calendar mr-1"></i>Bergabung {{ current_user.created_at.strftime('%d %b %Y') }}
                            </span>
                            <span class="px-3 py-1 bg-green-500/30 backdrop-blur-sm rounded-full text-sm font-medium border border-green-400/40">
                                <i class="fas fa-circle mr-1 animate-pulse"></i>Online
                            </span>
                        </div>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                        <div class="text-3xl font-bold text-white">{{ user_data|length }}</div>
                        <div class="text-blue-200 font-medium">User Tersedia</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="bg-gradient-to-br from-white to-blue-50 rounded-xl shadow-lg p-6 border border-blue-100 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fas fa-users text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total User</p>
                    <p class="text-2xl font-bold text-gray-900">{{ user_data|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-green-50 rounded-xl shadow-lg p-6 border border-green-100 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fas fa-comment text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Pesan Dikirim</p>
                    <p class="text-2xl font-bold text-gray-900">{{ current_user.sent_messages.count() }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-purple-50 rounded-xl shadow-lg p-6 border border-purple-100 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fas fa-envelope text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Pesan Diterima</p>
                    <p class="text-2xl font-bold text-gray-900">{{ current_user.received_messages.count() }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-orange-50 rounded-xl shadow-lg p-6 border border-orange-100 hover:shadow-xl transition-all duration-300">
            <div class="flex items-center">
                <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fas fa-clock text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Hari Bergabung</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ (datetime.utcnow() - current_user.created_at).days }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Alert -->
    {% if current_user.is_admin %}
    <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-6 shadow-lg">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fas fa-crown text-white"></i>
                </div>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-yellow-800">Mode Administrator</h3>
                <p class="text-yellow-700 mt-1 font-medium">
                    Anda memiliki akses penuh untuk mengelola semua user dan pengaturan sistem.
                    <a href="{{ url_for('admin_dashboard') }}" class="font-semibold underline hover:text-yellow-900 transition-colors">
                        Buka Panel Admin
                    </a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Aksi Cepat</h2>
        <div class="flex flex-wrap gap-4">
            <a href="{{ url_for('profile') }}" 
               class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg hover:shadow-xl">
                <i class="fas fa-user-edit"></i>
                <span class="font-medium">Edit Profil</span>
            </a>
            
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin_settings') }}" 
               class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-yellow-600 to-yellow-700 text-white rounded-xl hover:from-yellow-700 hover:to-yellow-800 transition-all duration-200 shadow-lg hover:shadow-xl">
                <i class="fas fa-cog"></i>
                <span class="font-medium">Pengaturan Admin</span>
            </a>
            {% endif %}
            
            <button onclick="refreshUsers()" 
                    class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg hover:shadow-xl">
                <i class="fas fa-sync-alt"></i>
                <span class="font-medium">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Users List -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800">Daftar User</h2>
                    <p class="text-gray-600 text-sm mt-1 font-medium">
                        {% if current_user.is_admin %}
                        Kelola semua user yang terdaftar
                        {% else %}
                        Pilih user untuk memulai chat
                        {% endif %}
                    </p>
                </div>
                <div class="flex items-center space-x-4 mt-3 md:mt-0">
                    <div class="flex items-center space-x-2 text-sm text-gray-600 font-medium">
                        <div class="w-3 h-3 bg-green-500 rounded-full shadow-sm"></div>
                        <span>Online</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-600 font-medium">
                        <div class="w-3 h-3 bg-gray-400 rounded-full shadow-sm"></div>
                        <span>Offline</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="divide-y divide-gray-100">
            {% for data in user_data %}
            {% set user = data.user %}
            {% set unread_count = data.unread_count %}
            <div class="px-6 py-6 hover:bg-blue-50/50 transition-all duration-200 group">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <!-- User Avatar -->
                        <div class="relative">
                            <img src="{{ user.profile_picture }}" alt="{{ user.username }}" 
                                 class="w-14 h-14 rounded-xl object-cover border-2 {% if user.is_admin %}border-yellow-400{% else %}border-gray-300{% endif %} shadow-md">
                            {% if user.is_online() %}
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full shadow-md"></div>
                            {% else %}
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-gray-400 border-2 border-white rounded-full shadow-md"></div>
                            {% endif %}
                            
                            {% if user.is_admin %}
                            <div class="absolute -top-1 -left-1 w-5 h-5 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full flex items-center justify-center shadow-md">
                                <i class="fas fa-crown text-yellow-900 text-xs"></i>
                            </div>
                            {% endif %}
                        </div>

                        <!-- User Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-2">
                                <h3 class="text-lg font-semibold text-gray-900 truncate">
                                    {{ user.username }}
                                </h3>
                                {% if user.is_admin %}
                                <span class="px-2 py-1 text-xs bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800 rounded-full font-medium border border-yellow-300">Admin</span>
                                {% endif %}
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-2 line-clamp-2 font-medium">
                                {% if user.bio %}
                                    {{ user.bio }}
                                {% else %}
                                    <span class="text-gray-400">Tidak ada bio</span>
                                {% endif %}
                            </p>
                            
                            <div class="flex items-center space-x-3">
                                {% if user.is_active %}
                                <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full font-medium">Aktif</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full font-medium">Nonaktif</span>
                                {% endif %}
                                
                                {% if user.is_blocked %}
                                <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full font-medium">Diblokir</span>
                                {% endif %}
                                
                                <span class="text-xs text-gray-500 font-medium">
                                    <i class="fas fa-clock mr-1"></i>
                                    {% if user.is_online() %}
                                    Online
                                    {% else %}
                                    {{ user.last_seen.strftime('%H:%M') }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-3">
                        <!-- Unread Count Badge -->
                        {% if unread_count > 0 %}
                        <div class="relative">
                            <span class="bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-lg animate-pulse">
                                {{ unread_count }}
                            </span>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                            <a href="{{ url_for('view_user_profile', user_id=user.id) }}" 
                               class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-all duration-200 shadow-sm hover:shadow-md tooltip"
                               title="Lihat Profil">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            {% if user.can_chat() %}
                            <a href="{{ url_for('chat', user_id=user.id) }}" 
                               class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg hover:shadow-md">
                                <i class="fas fa-comment"></i>
                                <span class="font-medium">Chat</span>
                                {% if unread_count > 0 %}
                                <span class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center ml-1">
                                    {{ unread_count }}
                                </span>
                                {% endif %}
                            </a>
                            {% else %}
                            <span class="px-4 py-2 bg-gray-200 text-gray-500 rounded-xl cursor-not-allowed tooltip shadow-sm"
                                  title="User tidak dapat dihubungi">
                                <i class="fas fa-ban mr-1"></i>Tidak Tersedia
                            </span>
                            {% endif %}
                            
                            {% if current_user.is_admin and not user.is_admin %}
                            <div class="flex space-x-1">
                                {% if user.is_blocked %}
                                <a href="{{ url_for('toggle_block_user', user_id=user.id) }}" 
                                   class="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-all duration-200 shadow-sm hover:shadow-md tooltip"
                                   title="Buka Blokir">
                                    <i class="fas fa-unlock"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('toggle_block_user', user_id=user.id) }}" 
                                   class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all duration-200 shadow-sm hover:shadow-md tooltip"
                                   title="Blokir User">
                                    <i class="fas fa-ban"></i>
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="px-6 py-12 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full mb-4 shadow-lg">
                    <i class="fas fa-users text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Belum Ada User Lain</h3>
                <p class="text-gray-500 max-w-md mx-auto font-medium">
                    {% if current_user.is_admin %}
                    Saat ini hanya ada Anda sebagai administrator di sistem.
                    {% else %}
                    Saat ini hanya ada administrator yang dapat diajak chat.
                    {% endif %}
                </p>
                {% if not current_user.is_admin %}
                <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl inline-block border border-blue-200">
                    <p class="text-sm text-blue-700 font-medium">
                        <i class="fas fa-info-circle mr-1"></i>
                        Admin Nayla Asyifa tersedia untuk diajak chat
                    </p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function refreshUsers() {
    window.location.reload();
}

// Add tooltip functionality
document.addEventListener('DOMContentLoaded', function() {
    const tooltips = document.querySelectorAll('.tooltip');
    tooltips.forEach(tooltip => {
        const title = tooltip.getAttribute('title');
        tooltip.removeAttribute('title');
        
        tooltip.addEventListener('mouseenter', function(e) {
            const tooltipEl = document.createElement('div');
            tooltipEl.className = 'absolute z-50 px-2 py-1 text-xs text-white bg-gray-900 rounded shadow-lg';
            tooltipEl.textContent = title;
            document.body.appendChild(tooltipEl);
            
            const rect = tooltip.getBoundingClientRect();
            tooltipEl.style.left = rect.left + 'px';
            tooltipEl.style.top = (rect.top - tooltipEl.offsetHeight - 5) + 'px';
            
            tooltip._tooltipEl = tooltipEl;
        });
        
        tooltip.addEventListener('mouseleave', function() {
            if (tooltip._tooltipEl) {
                tooltip._tooltipEl.remove();
            }
        });
    });
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.tooltip {
    position: relative;
}

/* Smooth transitions for all interactive elements */
* {
    transition-property: color, background-color, border-color, transform, box-shadow, opacity;
    transition-duration: 200ms;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
}
</style>
{% endblock %}